// Prisma Schema para ChinaFÃ¡cil Backend

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ===== ENUMS =====

enum UserRole {
  admin
  user
  seller
  lead
  sourcer
  client
}

enum UserStatus {
  active
  inactive
  suspended
}

enum SolicitationStatus {
  open
  pending
  in_progress
  finished
}

enum SubscriptionStatus {
  active
  inactive
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  PROPOSAL
  NEGOTIATION
  CONVERTED
  CLOSED_WON
  CLOSED_LOST
}

enum LeadOrigin {
  WEBSITE
  REFERRAL
  SOCIAL_MEDIA
  EMAIL
  PHONE
  TYPEFORM
  OTHER
}

enum NotificationType {
  INFO
  WARNING
  ERROR
  SUCCESS
}

// enum ExportStatus {
//   PENDING
//   PROCESSING
//   COMPLETED
//   FAILED
// }
// enum ExportType {
//   CSV
//   EXCEL
//   PDF
//   JSON
// }

// ===== MODELS =====

model User {
  id              String       @id @default(uuid())
  name            String
  email           String       @unique
  password        String
  phone           String?
  avatar          String?
  role            UserRole     @default(user)
  status          UserStatus   @default(active)
  phoneVerified   Boolean      @default(false) @map("phone_verified")
  employees       String?
  monthlyBilling  String?      @map("monthly_billing")
  cnpj            String?
  companyData     Json?        @map("company_data")
  emailVerifiedAt DateTime?    @map("email_verified_at")
  defaultAddress  String?      @map("default_address")
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")

  solicitations   Solicitation[]
  addresses       UserAddress[]
  favorites       FavoriteProduct[]
  clientUsers     ClientUser[]
  subscription    Subscription?
  sellerLeads     UserSellerLead[] @relation("Seller")
  leads           UserSellerLead[] @relation("Lead")
  taxCalculations TaxCalculation[]

  @@map("users")
}

model Client {
  id              String    @id @default(uuid())
  name            String
  price           Decimal   @db.Decimal(10, 2)
  supplierSearch  Int?      @map("supplier_search")
  viabilityStudy  Int?      @map("viability_study")
  planStatus      String?   @default("active") @map("plan_status")
  deletedAt       DateTime? @map("deleted_at")
  createdAt       DateTime? @default(now()) @map("created_at")
  updatedAt       DateTime? @updatedAt @map("updated_at")

  users         ClientUser[]
  solicitations Solicitation[]
  subscriptions Subscription[]

  @@map("clients")
}

model ClientUser {
  userId    String   @map("user_id")
  clientId  String   @map("client_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@id([userId, clientId])
  @@map("client_user")
}

model Solicitation {
  id              String              @id @default(uuid())
  userId          String              @map("user_id")
  clientId        String?             @map("client_id")
  type            String?
  status          SolicitationStatus  @default(open)
  quantity        Int?
  code            String?             @unique
  responsibleType String?             @map("responsible_type")
  responsibleId   String?             @map("responsible_id")
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")

  user  User    @relation(fields: [userId], references: [id])
  client Client? @relation(fields: [clientId], references: [id])

  items        SolicitationItem[]
  cart         Cart?
  trackingItems SolicitationTrack[]

  @@map("solicitations")
}

model SolicitationItem {
  id             String   @id @default(uuid())
  solicitationId String   @map("solicitation_id")
  productData    Json     @map("product_data")
  quantity       Int
  price          Decimal?
  status         String?
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  solicitation Solicitation               @relation(fields: [solicitationId], references: [id], onDelete: Cascade)
  attachments  SolicitationItemAttachment[]

  @@map("solicitation_items")
}

model SolicitationItemAttachment {
  id      String @id @default(uuid())
  itemId  String @map("item_id")
  fileUrl String @map("file_url")
  createdAt DateTime @default(now()) @map("created_at")

  item SolicitationItem @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@map("solicitation_item_attachments")
}

model SolicitationTrack {
  id             String   @id @default(uuid())
  solicitationId String   @map("solicitation_id")
  status         String
  description    String?
  date           DateTime
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  solicitation Solicitation @relation(fields: [solicitationId], references: [id], onDelete: Cascade)

  @@map("solicitation_tracks")
}

model Cart {
  id             String   @id @default(uuid())
  userId         String   @map("user_id")
  solicitationId String?  @unique @map("solicitation_id")
  items          Json
  pricingData    Json?    @map("pricing_data")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  solicitation Solicitation? @relation(fields: [solicitationId], references: [id], onDelete: SetNull)

  @@map("carts")
}

model Plan {
  id          BigInt   @id @default(autoincrement())
  name        String   @db.VarChar(50)
  subtitle    String?  @db.VarChar(100)
  image       String?  @db.VarChar(255)
  description String   @db.Text
  price       Float
  deletedAt   DateTime? @map("deleted_at")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("plans")
}

model Subscription {
  id                  Int                @id @default(autoincrement())
  userId              String             @unique @map("user_id")
  planId              String             @map("plan_id")
  price               Decimal            @map("price")
  status              SubscriptionStatus @default(active)
  currentPeriodStart  DateTime           @map("current_period_start")
  currentPeriodEnd    DateTime           @map("current_period_end")
  supplierSearch      Int                @default(0) @map("supplier_search")
  viabilityStudy      Int?               @map("viability_study")
  canceledAt          DateTime?          @map("canceled_at")
  createdAt           DateTime           @default(now()) @map("created_at")
  updatedAt           DateTime           @updatedAt @map("updated_at")

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  client Client @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

model ProductCatalog {
  id                        String   @id @default(uuid())
  categoryId                String?  @map("category_id")
  productMlbId              String   @map("product_mlb_id")
  mlbThumbnail              String?  @map("mlb_thumbnail")
  mlbTitle                  String?  @map("mlb_title")
  mlbPrice                  Decimal? @map("mlb_price")
  mlbSoldQuantity           Int?     @map("mlb_sold_quantity")
  mlbSoldValue              Decimal? @map("mlb_sold_value")
  mlbPermalink              String?  @map("mlb_permalink")
  product1688Id              String?  @map("product_1688_id")
  product1688Price          Decimal? @map("product_1688_price")
  product1688GoodsScore     Decimal? @map("product_1688_goods_score")
  product1688Title          String?  @map("product_1688_title")
  product1688TranslatedTitle String? @map("product_1688_translated_title")
  product1688QuantityBegin  Int?     @map("product_1688_quantity_begin")
  categoryIds               Json?    @map("category_ids")
  isSimilar                 Boolean? @map("is_similar")
  createdAt                 DateTime @default(now()) @map("created_at")
  updatedAt                 DateTime @updatedAt @map("updated_at")

  @@index([productMlbId])
  @@map("product_catalog")
}

model FavoriteProduct {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  itemId      String?  @map("item_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("favorite_products")
}

model UserAddress {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  street       String
  number       String
  complement   String?
  neighborhood String
  city         String
  state        String
  postalCode   String   @map("postal_code")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_addresses")
}

model BoardingType {
  id                  String   @id @default(uuid())
  cmbStart            Int      @map("cmb_start")
  cmbEnd              Int      @map("cmb_end")
  internationalShipping Float    @db.Double @map("international_shipping")
  taxBlAwb            Float    @db.Double @map("tax_bl_awb")
  storageAir          Float    @db.Double @map("storage_air")
  storageSea          Float    @db.Double @map("storage_sea")
  taxAfrmm            Float    @db.Double @map("tax_afrmm")
  dispatcher          Float    @db.Double
  sda                 Float    @db.Double
  deliveryTransport   Float    @db.Double @map("delivery_transport")
  otherFees           Float?   @db.Double @map("other_fees")
  brazilExpenses      Float    @db.Double @map("brazil_expenses")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  @@map("boarding_types")
}

model Freight {
  id              BigInt   @id @default(autoincrement())
  destino         String   @db.VarChar(255)
  uf              String   @db.VarChar(2)
  taxaMin         Decimal  @db.Decimal(10, 4) @map("taxa_min")
  peso10          Decimal  @db.Decimal(10, 4) @map("peso_10")
  peso20          Decimal  @db.Decimal(10, 4) @map("peso_20")
  peso35          Decimal  @db.Decimal(10, 4) @map("peso_35")
  peso50          Decimal  @db.Decimal(10, 4) @map("peso_50")
  peso70          Decimal  @db.Decimal(10, 4) @map("peso_70")
  peso100         Decimal  @db.Decimal(10, 4) @map("peso_100")
  peso300         Decimal  @db.Decimal(10, 4) @map("peso_300")
  peso500         Decimal  @db.Decimal(10, 4) @map("peso_500")
  entregaAte10kg  Decimal  @db.Decimal(10, 4) @map("entrega_ate_10kg")
  excDeEntrega    Decimal  @db.Decimal(10, 4) @map("exc_de_entrega")
  advalorem       Decimal  @db.Decimal(10, 4)
  gris            Decimal  @db.Decimal(10, 4)
  grisMin         Decimal  @db.Decimal(10, 4) @map("gris_min")
  pedagio100      Decimal  @db.Decimal(10, 4) @map("pedagio_100")
  sla             String   @db.VarChar(255)
  cep             String   @db.VarChar(10)
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@map("fretes")
}


model TaxCalculation {
  id                  BigInt   @id @default(autoincrement())
  userId              String?  @map("user_id") @db.VarChar(36)
  userEmail           String?  @map("user_email") @db.VarChar(255)
  tempUserId          String?  @map("temp_user_id") @db.VarChar(50)
  productName         String   @map("product_name") @db.VarChar(255)
  productImageUrl     String?  @map("product_image_url") @db.VarChar(255)
  ncmCode             String?  @map("ncm_code") @db.VarChar(20)
  volumeUn            Decimal  @map("volume_un") @db.Decimal(10, 4)
  weightUn            Decimal  @map("weight_un") @db.Decimal(10, 2)
  quantity            Int
  unitPriceBrl         Decimal  @map("unit_price_brl") @db.Decimal(12, 2)
  currency            String   @db.VarChar(3) @default("BRL")
  unitPriceOriginal   Decimal? @map("unit_price_original") @db.Decimal(12, 2)
  yuanRate            Decimal? @map("yuan_rate") @db.Decimal(8, 4)
  dolarRate           Decimal? @map("dolar_rate") @db.Decimal(8, 4)
  distanceKm          Decimal? @map("distance_km") @db.Decimal(8, 2)
  volumeType          String   @map("volume_type") @default("unitario")
  weightType          String   @map("weight_type") @default("unitario")
  totalVolume         Decimal  @map("total_volume") @db.Decimal(10, 4)
  totalWeight         Decimal  @map("total_weight") @db.Decimal(10, 2)
  supplierPrice       Decimal  @map("supplier_price") @db.Decimal(12, 2)
  totalCost           Decimal  @map("total_cost") @db.Decimal(12, 2)
  calculationBreakdown Json?   @map("calculation_breakdown")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([userEmail])
  @@index([tempUserId])
  @@index([createdAt])
  @@map("tax_calculations")
}

model CalculatorUser {
  id        String   @id @db.Char(36)
  email     String   @unique @db.VarChar(255)
  telefone  String   @db.VarChar(255)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("calculator_users")
}

model UserSellerLead {
  sellerId  String   @map("seller_id")
  leadId    String   @map("lead_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  seller User @relation("Seller", fields: [sellerId], references: [id], onDelete: Cascade)
  lead   User @relation("Lead", fields: [leadId], references: [id], onDelete: Cascade)

  @@id([sellerId, leadId])
  @@map("user_seller_leads")
}

model Notification {
  id             String   @id @default(uuid())
  type           String
  notifiableType String   @map("notifiable_type")
  notifiableId   String   @map("notifiable_id") @db.VarChar(36)
  data           String   @db.Text
  readAt         DateTime? @map("read_at")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  @@index([notifiableType, notifiableId])
  @@map("notifications")
}


// model Export {
//   id          String        @id @default(uuid())
//   userId      String        @map("user_id")
//   type        ExportType
//   status      ExportStatus  @default(PENDING)
//   fileName    String?       @map("file_name")
//   fileUrl     String?       @map("file_url")
//   filters     Json?
//   totalRows   Int?          @map("total_rows")
//   error       String?       @db.Text
//   startedAt   DateTime?     @map("started_at")
//   completedAt DateTime?     @map("completed_at")
//   createdAt   DateTime      @default(now()) @map("created_at")
//   updatedAt   DateTime      @updatedAt @map("updated_at")
//   @@map("exports")
// }
